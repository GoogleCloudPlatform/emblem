# Copyright 2021 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

steps:
  # Prints entire body of pub/sub message for debugging
  - name: gcr.io/cloud-builders/gcloud
    entrypoint: /bin/bash
    args:
      - '-c'
      - |
        echo ${_BODY}

  # Simple health check, index should return 200.
  - name: gcr.io/cloud-builders/gcloud
    entrypoint: /bin/bash
    args:
      - '-c'
      - |
        URL=$(gcloud run services describe website --format "value(status.url)" --region=${_REGION} --project=${_TARGET_PROJECT})
        latest=$(echo "${URL/https:\/\//${_REVISION}---}")
        set -e
        curl -si --fail --show-error https://$latest
  
  # Failure will halt the pipeline progress 
  # and traffic percentage will remain same

  # TODO: In case of failure, revert back to previous revision

  # Cloud Run Canary
  - id: 'Update Traffic'
    name: 'gcr.io/cloud-builders/gcloud'
    args:
    - 'run'
    - 'services'
    - 'update-traffic'
    - '${_SERVICE}'
    - '--to-revisions'
    - '${_SERVICE}-${_REVISION}=${_TRAFFIC}'
    - '--region=${_REGION}'
    - '--platform=managed'
    - '--project=${_TARGET_PROJECT}'

  # This build uses Pub/Sub to trigger *subsequent* builds that 
  # increase traffic until it reaches 100%.
  # Once this is complete, this build will start the canary rollout to prod.
  - name: 'gcr.io/cloud-builders/gcloud'
    entrypoint: /bin/bash
    args:
      - -c
      - |
        if [ ${_TRAFFIC} -lt 100 ]
        then gcloud pubsub topics publish canary-${_TARGET_PROJECT} \
        --message="Increase ${_SERVICE}-${_REVISION} traffic to $((${_TRAFFIC}+5))" \
        --attribute=_TARGET_PROJECT=${_TARGET_PROJECT},_IMAGE_NAME=${_IMAGE_NAME},_ENV=${_ENV},_SERVICE=${_SERVICE},_REVISION=${_REVISION},_REGION=${_REGION},_TRAFFIC=$((${_TRAFFIC}+5))
        elif [ ${_ENV} = "staging" ]
        then gcloud pubsub topics publish deploy-prod \
        --message="Deploying ${_SERVICE}-prod-${_REVISION}" \
        --attribute=_TARGET_PROJECT=${_TARGET_PROJECT},_IMAGE_NAME=${_IMAGE_NAME},_ENV=prod,_SERVICE=${_SERVICE},_REVISION=${_REVISION},_REGION=${_REGION},_TRAFFIC=$((${_TRAFFIC}+5))
        fi
